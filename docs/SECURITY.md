# SECURITY.md — политика безопасности ChatBotChef

Документ описывает требования к обращению с секретами, настройке инфраструктуры и ведению логов.

## Секреты и учётные данные

- `TELEGRAM_TOKEN`, `OPENAI_API_KEY`, `PROVIDER_TOKEN` и другие чувствительные параметры хранятся только в окружении (`.env`).
- Файл `/root/.env` должен иметь права `600` и принадлежать пользователю, от которого запускается сервис.
- Никогда не передавайте `.env` и JAR через общие репозитории/чаты. Используйте SCP или менеджеры секретов (например, Ansible
  Vault, sops, Hashicorp Vault).
- При необходимости аудита доступа журналируйте выдачу секретов отдельно (внешний реестр).

## Логи и персональные данные

- Приложение маскирует токены (`BOOT-TOKENS`, `BOOT-OPENAI-HEADERS`) и не пишет payload платежей целиком.
- При ошибках OpenAI/Telegram логируется только усечённый ответ (`≤400` символов) без PII.
- Админ-команды журналируются через `ADMIN-AUDIT` и дополнительно попадают в таблицу `admin_audit` (кто/что/когда).
- В логах не появляются e-mail и телефон пользователя; в случае ошибок хранения сообщений выводится только длина текста.

## Управление доступом

- В `ADMIN_IDS` перечисляются числовые Telegram ID сотрудников с правами администратора. Любые команды вне списка
  игнорируются и логируются.
- Админ-панель автоматически сбрасывается при `/start` и любых пользовательских командах.
- Рекомендуется настроить двухфакторную защиту Telegram-аккаунтов администраторов.

## Сеть и инфраструктура

- Ограничьте входящий трафик firewall'ом: разрешите только исходящие соединения к `api.telegram.org` и `api.openai.com`,
  входящие — по SSH (22/TCP).
- Обновляйте систему безопасности `apt update && apt upgrade` минимум раз в месяц.
- Для OpenAI реализованы ретраи с экспоненциальной задержкой и корректная обработка 403 (`unsupported_region`), 429 и 5xx.
- Telegram HTTP ошибки (429, 5xx) обрабатываются с повторами и бэкоффом во время рассылок.

## Базы данных и резервные копии

- SQLite-файл хранится в `/root/data`. Не размещайте его на сетевых файловых системах без поддержки `flock`.
- Используйте `scripts/sqlite_backup.sh` совместно с cron/systemd timer для ежедневной ротации бэкапов (по умолчанию 14 дней).
- Резервные копии содержат пользовательские идентификаторы Telegram; храните их в защищённом каталоге с ограниченным доступом.

## Обновления и инциденты

- Любые изменения должны проходить через `./gradlew clean test fatJar` и [docs/RELEASE_CHECKLIST.md](RELEASE_CHECKLIST.md).
- После инцидентов (ошибка OpenAI, массовый 429 и т.п.) проверьте `OPENAI-HTTP-ERR`, `TG-HTTP-ERR`, `ADMIN-*` логи и состояние
  таблицы `admin_audit`.
- При компрометации токенов немедленно отзовите их (BotFather → Revoke, OpenAI Dashboard → API keys) и обновите `.env`.
