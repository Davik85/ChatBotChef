# ENV.md — переменные окружения ChatBotChef

Бот читает настройки из переменных окружения (при запуске под systemd) или из файла `.env` в корне проекта на локальной
машине. Ниже приведён полный список параметров с указанием обязательности и значений по умолчанию.

## Обязательные параметры

| Переменная        | Описание                                                                 | Формат/пример                         |
|-------------------|--------------------------------------------------------------------------|---------------------------------------|
| `TELEGRAM_TOKEN`  | Токен бота из @BotFather. Валидируется по формату `123456:ABC…`.          | `123456789:AAABBBCCCDDDEE`            |
| `OPENAI_API_KEY`  | Ключ доступа к OpenAI Chat Completions. Поддерживаются `sk-` и `sk-proj-`.| `sk-abc123...`                        |

Если хотя бы один из токенов не задан или не проходит валидацию — приложение завершится с ошибкой сразу после старта.

## Telegram / общие настройки

| Переменная       | По умолчанию                | Описание                                                                                  |
|------------------|-----------------------------|-------------------------------------------------------------------------------------------|
| `DB_PATH`        | `data/chatbotchef.sqlite`   | Путь к SQLite-базе. Каталог создаётся автоматически, но убедитесь, что у процесса есть права. |
| `ADMIN_IDS`      | — (пусто)                   | Список Telegram ID администраторов через запятую. Без него админ-панель недоступна.       |
| `DEBUG`          | `false`                     | При значении `true` включает подробный лог запросов `sendInvoice` (провайдерский токен маскируется). |

## OpenAI

| Переменная        | По умолчанию | Описание                                                                                         |
|-------------------|--------------|--------------------------------------------------------------------------------------------------|
| `OPENAI_ORG`      | —            | Идентификатор организации. Отправляется в заголовке `OpenAI-Organization`, если не пустой.       |
| `OPENAI_PROJECT`  | —            | Идентификатор проекта OpenAI (заголовок `OpenAI-Project`).                                       |

Дополнительно в коде заданы лимиты: `OPENAI_MAX_TOKENS=1800`, `MAX_REPLY_CHARS=1800`, `HISTORY_MAX_TURNS=30`. Изменяются
только через изменение исходного кода.

## Подписка и платежи

| Переменная                | По умолчанию | Описание                                                                                                                        |
|---------------------------|--------------|---------------------------------------------------------------------------------------------------------------------------------|
| `PROVIDER_TOKEN`          | —            | Токен провайдера платежей (BotFather → Payments). Без него платёжные сценарии отключены.                                        |
| `PREMIUM_PRICE_RUB`       | `700`        | Стоимость подписки в рублях. Фактическая сумма в инвойсе — значение × 100 (копейки).                                           |
| `PREMIUM_DAYS`            | `30`         | Срок действия премиума в днях. Используется как для оплаты, так и для ручной выдачи администратором.                            |
| `PAYMENT_SUBJECT`         | `service`    | Поле `payment_subject` в чеке 54-ФЗ.                                                                                            |
| `PAYMENT_MODE`            | `full_prepayment` | Поле `payment_mode` в чеке 54-ФЗ.                                                                                            |
| `RECEIPTS_ENABLED`        | `true` (если `NPD_MODE=false`) | Управляет формированием чеков. При `false` чек не отправляется и налоговые поля игнорируются. |
| `NPD_MODE`                | `false`      | Режим самозанятого. При `true` чеки не формируются независимо от других настроек.                                                |
| `TAX_SYSTEM_CODE`         | `2`          | Система налогообложения (1–6) для чека. Учитывается только при активных чеках и `NPD_MODE=false`.                               |
| `VAT_CODE`                | `6`          | Код ставки НДС (1–6, где 6 — «без НДС»). Используется при формировании чеков.                                                   |
| `REQUIRE_PHONE_FOR_RECEIPT` | `true`      | Запрос номера телефона в инвойсе. Автоматически сбрасывается в `false`, если чеки отключены или активирован режим НПД.          |
| `REQUIRE_EMAIL_FOR_RECEIPT` | `true`      | Запрос e-mail в инвойсе. При отключённых чеках принудительно `false`.                                                           |

### Поведение чеков

- Если `NPD_MODE=true`, параметры `RECEIPTS_ENABLED`, `TAX_SYSTEM_CODE`, `VAT_CODE`, `PAYMENT_SUBJECT`, `PAYMENT_MODE` и
  флаги `REQUIRE_*` игнорируются, а в Telegram не передаётся `provider_data.receipt`.
- Если `RECEIPTS_ENABLED=false`, чек не формируется, но режим НПД остаётся выключенным.
- При некорректных значениях (например, `TAX_SYSTEM_CODE` вне диапазона) бот завершит работу с понятной ошибкой.

## Ограничения и лимиты

| Параметр                     | Значение по умолчанию | Комментарий                                                         |
|------------------------------|------------------------|----------------------------------------------------------------------|
| `FREE_TOTAL_MSG_LIMIT`       | `10`                   | Глобальный лимит на количество сообщений для бесплатного пользователя. Изменяется в `AppConfig`. |
| `HISTORY_MAX_TOTAL_CHARS`    | `12_000`               | Лимит длины контекста для запроса к OpenAI.                         |
| `MAX_REPLY_CHARS`            | `1_800`                | Жёсткий максимум символов в ответе, отправляемом пользователю.      |

Эти параметры зашиты в коде и изменяются только через пересборку приложения.

## Пример полного `.env`

```dotenv
TELEGRAM_TOKEN=123456789:example
OPENAI_API_KEY=sk-...
ADMIN_IDS=123456789,987654321
DB_PATH=/root/data/chatbotchef.sqlite

# Платежи (опционально)
PROVIDER_TOKEN=284685063:TEST:abcdef
PREMIUM_PRICE_RUB=699
PREMIUM_DAYS=30
RECEIPTS_ENABLED=true
TAX_SYSTEM_CODE=2
VAT_CODE=6
REQUIRE_PHONE_FOR_RECEIPT=false
REQUIRE_EMAIL_FOR_RECEIPT=true

# Для sandbox-тестов без чеков
# NPD_MODE=true
```

## Советы по безопасности

- `.env` добавлен в `.gitignore` и не должен попадать в репозиторий или артефакты.
- При использовании systemd храните переменные в `/root/.env` с правами `600` и указывайте путь через `EnvironmentFile=`.
- Никогда не логируйте значения токенов и ключей вручную: стартовые логи уже выводят только маскированные версии.
