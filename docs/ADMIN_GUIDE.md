# ADMIN_GUIDE.md — руководство администратора ChatBotChef

Этот документ описывает рабочие сценарии для админов бота: как открыть панель, что означают пункты меню и какие ограничения
следует учитывать.

## Доступ и вход в панель

1. Убедитесь, что ваш Telegram ID указан в переменной `ADMIN_IDS` (см. [docs/ENV.md](ENV.md)).
2. Отправьте боту команду `/admin` либо нажмите кнопку «Стартовое меню» → «Админ-панель» (появляется после `/admin`).
3. В логах появится запись `ADMIN-AUDIT: action=menu_open`. Любые дальнейшие действия логируются и сохраняются в таблицу `admin_audit`.

> Важно: при вводе любой пользовательской команды (`/start`, `/recipes`, `/reset` и т.п.) админ-режим сбрасывается. Чтобы
> вернуться в панель, вызовите `/admin` повторно.

## Элементы меню

| Кнопка/команда                     | Назначение                                                                                          |
|-----------------------------------|------------------------------------------------------------------------------------------------------|
| «Создать рассылку»                | Запуск массовой рассылки. Запросит текст, затем потребует подтверждение.                             |
| «Статистика»                      | Показ основных метрик (установки, активные за 7 дней, премиум, блокировки).                          |
| «Проверить статус пользователя»   | Запрос Telegram ID → вывод информации о премиуме, активности и блокировках.                         |
| «Выдать премиум»                  | Ручная выдача подписки: введите ID и количество дней.                                                |
| `/premiumstatus <id>`             | Командный аналог проверки статуса.                                                                   |
| `/grantpremium <id> <days>`       | Командный аналог выдачи премиума.                                                                    |
| `/cancel`                         | Отмена текущей операции (рассылка, ввод ID, выдача премиума).                                        |

## Рассылки

- Максимальный размер одного сообщения — 4096 символов. Если текст длиннее, бот разделит его на несколько частей.
- Отправка идёт батчами по 500 пользователей с задержкой 250 мс между сообщениями. При кодах 429 и 5xx применяется бэкофф.
- Заблокированные пользователи отмечаются (`UsersRepo.markBlocked`), в логе появится `ADMIN-BROADCAST-ERR reason=forbidden`.
- По завершении выводится сводка «Отправлено / Ошибок» и создаётся запись `broadcast_done` в `admin_audit`.

## Статистика

- Строки, которые выводит бот:
  - «Установок бота» — количество уникальных ID во всех таблицах (users/messages/premium/usage).
  - «Активных установок» — аудитория без заблокированных пользователей.
  - «Активно за 7 дней» — число пользователей с сообщениями за последнюю неделю.
  - «Премиум-пользователей» — активные подписки (`until_ts > now`).
  - «Заблокировали бота» — пользователи, вернувшие `403` или отметившие бота как спам.
- Перед показом статистики выполняется `UsersRepo.repairOrphans`, чтобы подтянуть старые ID.

## Проверка и выдача премиума

- Вводите чистый Telegram ID без `@` и пробелов. Бот нормализует значение (`parseTelegramId`).
- Выдача доступна только на положительное количество дней. При ошибках бот сообщит о формате и запишет событие в `ADMIN-GRANT`.
- После успешного продления выводится дата окончания (UTC→локальное время сервера).

## Напоминания и уведомления

- Напоминания об окончании подписки (за 2 и 1 день) отправляются автоматически и записываются в таблицу `premium_reminders`.
- Проверять прогресс можно по логам `ReminderJob` и статусам в `admin_audit`.

## Диагностика и логи

- Все админ-действия помечены префиксом `ADMIN-*`. Для детальной трассировки используйте:
  ```bash
  sudo journalctl -u chatbotchef.service | grep ADMIN-
  ```
- Таблица `admin_audit` пригодится для расследования инцидентов: `SELECT * FROM admin_audit ORDER BY ts DESC LIMIT 50;`.
- Ошибки OpenAI: ищите `OPENAI-HTTP-ERR` или `OPENAI-COMPLETE-ERR`.
- Ошибки Telegram: `TG-HTTP-ERR`, `TG-POLL-ERR`.

## Рекомендации

- Перед массовыми рассылками тестируйте текст на внутреннем боте/аудитории.
- При выдаче премиума сохраняйте ссылку на платёж или тикет в `meta` (пока сохраняется длина и источник); при необходимости
  можно расширить схему `admin_audit`.
- При любом необычном поведении (много `failed` в рассылке, ошибки платежей) сообщайте разработчику и прикладывайте логи.
