# ADMIN_GUIDE.md — руководство администратора ChatBotChef

Этот документ описывает рабочие сценарии для админов бота: как открыть панель, что означают пункты меню и какие ограничения
следует учитывать.

## Доступ и вход в панель

1. Убедитесь, что ваш Telegram ID указан в переменной `ADMIN_IDS` (см. [docs/ENV.md](ENV.md)).
2. Отправьте боту команду `/admin` либо нажмите кнопку «Стартовое меню» → «Админ-панель» (появляется после `/admin`).
3. В логах появится запись `ADMIN-AUDIT: action=menu_open`. Любые дальнейшие действия логируются и сохраняются в таблицу `admin_audit`.

> Важно: при вводе любой пользовательской команды (`/start`, `/recipes`, `/reset` и т.п.) админ-режим сбрасывается. Чтобы
> вернуться в панель, вызовите `/admin` повторно.

> Администраторы перечисляются в переменной `ADMIN_IDS`. Для них не действуют бесплатные лимиты — счётчик `usage_counters`
> не увеличивается, а доступ к режимам всегда открыт.

## Элементы меню

| Кнопка/команда                     | Назначение                                                                                          |
|-----------------------------------|------------------------------------------------------------------------------------------------------|
| «Создать рассылку»                | Запуск массовой рассылки. Запросит текст, затем потребует подтверждение.                             |
| «Статистика»                      | Показ основных метрик (установки, активные за 7 дней, премиум, блокировки).                          |
| «Проверить статус пользователя»   | Запрос Telegram ID → вывод информации о премиуме, активности и блокировках.                         |
| «Выдать премиум»                  | Ручная выдача подписки: введите ID и количество дней.                                                |
| `/premiumstatus <id>`             | Командный аналог проверки статуса.                                                                   |
| `/grantpremium <id> <days>`       | Командный аналог выдачи премиума.                                                                    |
| `/cancel`                         | Отмена текущей операции (рассылка, ввод ID, выдача премиума).                                        |

## Рассылки

- Максимальный размер одного сообщения — 4096 символов. Если текст длиннее, бот разделит его на несколько частей.
- Отправка идёт батчами по 500 пользователей с задержкой 250 мс между сообщениями. При кодах 429 и 5xx применяется бэкофф.
- Аудитория формируется из таблицы `users`: берём только тех, у кого `blocked = 0` и `blocked_ts <= 0`. При ошибке доставки
  «bot was blocked…» вызывается `UserService.markBlocked`, в логах появляется `BROADCAST-USER-BLOCKED`, а рассылка продолжается.
- По завершении выводится расширенная сводка («Всего», «Успешно», «Блокировки», «Ошибок») и создаётся запись
  `broadcast_done` в `admin_audit` с теми же показателями.

## Статистика

- Строки, которые выводит бот:
  - «Установок бота» — количество строк в `users`.
  - «Активных установок» — разница `total - blocked` (все записи без признака блокировки).
  - «Активно за 7 дней» — пользователи с `users.last_seen >= now - 7 суток`.
  - «Премиум-пользователей» — активные подписки (`premium_users.until_ts > now`).
  - «Заблокировали бота» — пользователи, у которых `blocked = 1` или `blocked_ts > 0`.
- Перед показом статистики выполняется `UsersRepo.repairOrphans`, чтобы подтянуть старые ID и заполнить `first_seen`/`last_seen`.
- Расчёты выполняет `StatsService.collect()`, что исключает сложные `JOIN` и ошибки вида «Cannot join with app.db.Users…».

## Проверка и выдача премиума

- Вводите чистый Telegram ID без `@` и пробелов. Бот нормализует значение (`parseTelegramId`).
- Выдача доступна только на положительное количество дней. При ошибках бот сообщит о формате и запишет событие в `ADMIN-GRANT`.
- После успешного продления выводится дата окончания (UTC→локальное время сервера).

## Напоминания и уведомления

- Напоминания об окончании подписки (за 2 и 1 день) отправляются автоматически и записываются в таблицу `premium_reminders`.
- Проверять прогресс можно по логам `ReminderJob` и статусам в `admin_audit`.

## Диагностика и логи

- Все админ-действия помечены префиксом `ADMIN-*`. Для детальной трассировки используйте:
  ```bash
  sudo journalctl -u chatbotchef.service | grep ADMIN-
  ```
- Таблица `admin_audit` пригодится для расследования инцидентов: `SELECT * FROM admin_audit ORDER BY ts DESC LIMIT 50;`.
- Ошибки OpenAI: ищите `OPENAI-HTTP-ERR` или `OPENAI-COMPLETE-ERR`.
- Ошибки Telegram: `TG-HTTP-ERR`, `TG-POLL-ERR`.

## Рекомендации

- Перед массовыми рассылками тестируйте текст на внутреннем боте/аудитории.
- При выдаче премиума сохраняйте ссылку на платёж или тикет в `meta` (пока сохраняется длина и источник); при необходимости
  можно расширить схему `admin_audit`.
- При любом необычном поведении (много `failed` в рассылке, ошибки платежей) сообщайте разработчику и прикладывайте логи.
