# ChatBotChef

ChatBotChef — Telegram-бот, который помогает подбирать идеи рецептов на базе GPT. Проект написан на Kotlin и работает
через long polling Telegram API. Бот хранит историю диалогов и платежей в локальной SQLite-базе и поддерживает
премиум-подписку для снятия лимитов.

## Возможности
- генерация советов по рецептам с использованием OpenAI Chat Completions;
- ограничение количества сообщений для бесплатных пользователей и отдельный paywall-текст;
- выдача премиум-подписки после оплаты в Telegram Payments;
- отправка чеков 54-ФЗ при необходимости, с настройкой режима самозанятого;
- хранение истории запросов пользователей, платежей и статусов в SQLite.

## Стек
- **Kotlin/JVM** + Gradle (Kotlin DSL);
- **Telegram Bot API** (long polling);
- **OpenAI API** для генерации текста;
- **SQLite** через `org.jetbrains.exposed` для хранения данных;
- `dotenv-kotlin` для подстановки переменных из `.env` на локальной машине.

## Требования
- Java 17+ (Gradle скачает нужный JDK, если его нет локально);
- аккаунты в Telegram и OpenAI с активными токенами;
- при использовании платежей — токен провайдера от BotFather.

## Конфигурация окружения
Все параметры читаются из переменных окружения или файла `.env` в корне проекта.

### Обязательные параметры
| Переменная | Описание |
|------------|----------|
| `TELEGRAM_TOKEN` | токен бота из BotFather. Формат проверяется валидатором. |
| `OPENAI_API_KEY` | API-ключ OpenAI (`sk-...` или `sk-proj-...`). |

### OpenAI (опционально)
- `OPENAI_ORG` — идентификатор организации, если требуется.
- `OPENAI_PROJECT` — идентификатор проекта OpenAI.

### Платежи в Telegram
Платежные сценарии включаются автоматически при наличии `PROVIDER_TOKEN`.
- `PROVIDER_TOKEN` — токен провайдера платежей из BotFather (без него оплата отключена).
- `PREMIUM_PRICE_RUB` — стоимость подписки в рублях (по умолчанию `700`).
- `PREMIUM_DAYS` — срок подписки в днях (по умолчанию `30`).

#### Параметры чеков (54-ФЗ)
Чеки включены по умолчанию. Значения `TAX_SYSTEM_CODE` и `VAT_CODE` продолжают считываться из окружения.
Если вы самозанятый (НПД), достаточно указать `NPD_MODE=true` — сервис автоматически перестанет отправлять чек
и проигнорирует налоговые переменные.

Чтобы вручную отключить отправку чеков (для любых других сценариев), добавьте `RECEIPTS_ENABLED=false`.
При выключенных чеках (`NPD_MODE=true` или `RECEIPTS_ENABLED=false`) `TAX_SYSTEM_CODE` и `VAT_CODE` можно удалить из
окружения — сервис не будет отправлять налоговые атрибуты, а `REQUIRE_EMAIL_FOR_RECEIPT` и
`REQUIRE_PHONE_FOR_RECEIPT` автоматически сбросятся в `false`.

Дополнительные параметры чеков:
- `PAYMENT_SUBJECT` (по умолчанию `service`),
- `PAYMENT_MODE` (по умолчанию `full_prepayment`),
- `REQUIRE_PHONE_FOR_RECEIPT` (`false` по умолчанию, принудительно `false`, если чеки отключены),
- `REQUIRE_EMAIL_FOR_RECEIPT` (`true` по умолчанию, принудительно `false`, если чеки отключены).

### Прочие параметры
- `DB_PATH` — путь к SQLite-файлу (по умолчанию `data/chatbotchef.sqlite`).
- `FREE_TOTAL_MSG_LIMIT` задаётся в коде (`AppConfig`) и описывает глобальный лимит бесплатных запросов.

### Пример `.env`
```dotenv
TELEGRAM_TOKEN=123456789:example
OPENAI_API_KEY=sk-...
PROVIDER_TOKEN=284685063:test:example
PREMIUM_PRICE_RUB=699
PREMIUM_DAYS=30
NPD_MODE=false
```

## Запуск
```bash
./gradlew run
```
По умолчанию бот стартует в режиме long polling и подключается к Telegram API. В закрытых сетях может потребоваться
настроить прокси для Gradle и/или Telegram.

## Разработка и отладка
- Для локального тестирования удобно использовать отдельного бота в Telegram и sandbox токен для платежей.
- Логи отправляются в STDOUT; на старте приложение выводит статус ключей и результат инициализации OpenAI/БД.
- SQLite-файл создаётся автоматически по пути `DB_PATH`. Для инспекции данных можно открыть его любым SQLite-клиентом.

## Деплой
Проект не содержит специфичных скриптов деплоя. Для продакшн-среды обычно достаточно:
1. Собрать "толстый" JAR: `./gradlew fatJar` (готовый файл появится в `build/libs/ChatBotChef-all.jar`).
2. Настроить systemd/PM2/другой процесс-менеджер, который будет перезапускать приложение при сбоях.
3. Задать переменные окружения через `.env`, Docker secrets или менеджер секретов.

> **Примечание:** при деплое убедитесь, что машина имеет доступ к `api.telegram.org` и `api.openai.com`.
